<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>casa</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
  </style>
  <link rel="stylesheet" href="../../theme/css/pandoc.css" />
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<nav id="TOC" role="doc-toc">
<ul>
<li><a href="#learning-casa-based-radio-data-reduction">Learning CASA based radio data reduction</a>
<ul>
<li><a href="#step-1---obtaining-public-data">Step 1 - Obtaining public data</a></li>
<li><a href="#step2---converting-.idifits-format-data-to-casa-measurement-sets">Step2 - Converting “.idifits” format data to CASA Measurement Sets</a></li>
<li><a href="#step-3---handling-.ms-file-ref">Step 3 - Handling .ms file <span>(Ref)</span></a></li>
<li><a href="#install-casacore-aoflagger-and-wsclean-on-debian">Install casacore, aoflagger and wsclean on Debian</a></li>
</ul></li>
</ul>
</nav>
<h2 id="learning-casa-based-radio-data-reduction">Learning CASA based radio data reduction</h2>
<ul>
<li>Resource 1: <a href="https://www.jive.eu/casa-vlbi2020/index.php">CASA-VLBI workshop 2020</a></li>
<li>Related tools need to be installed: casacore (can not be installed on MacOs on 2020.11.29), Aoflagger, Wsclean. (All can be installed on Ubuntu.)</li>
</ul>
<h3 id="step-1---obtaining-public-data">Step 1 - Obtaining public data</h3>
<p>The data can be obtained from the <a href="https://archive.nrao.edu/archive/advquery.jsp">NRAO Science Data Archive : Advanced Search Tool</a></p>
<p>After opening that website, in ‘’Target Name’’ box, fill in <strong>XXXX</strong> then click “Submit Query”, then all the publicly available data related to that source can be downloaded following the instructions on the website.</p>
<p>The data may in “.uvfits” or “.idifits” formats.</p>
<h3 id="step2---converting-.idifits-format-data-to-casa-measurement-sets">Step2 - Converting “.idifits” format data to CASA Measurement Sets</h3>
<p>Before handling in CASA, the original “.idifits” format data needs to be converted to the CASA Measurement Sets format. Using the <a href="https://casa.nrao.edu/docs/UserMan/casa_cookbook003.html#section%3Aio.import.uvfitsidi.import"><strong>importfitsidi</strong></a> task of CASA:</p>
<p>In CASA, <code>importfitsidi</code> tool is used to import a idifits file</p>
<p>First open casa software in terminal, and then type (see <a href="https://casaguides.nrao.edu/index.php/Getting_Started_in_CASA">Getting Started in CASA</a>):</p>
<pre class="shell"><code>#casa 5.6.1
tget importfitsidi
inp
fitsidifile = &quot;input.idifits&quot;
vis = &quot;output.ms&quot;
go</code></pre>
<p>The code will run and a resultant “.ms” file will be stored for later processing processes.</p>
<h3 id="step-3---handling-.ms-file-ref">Step 3 - Handling .ms file <a href="http://www.jb.man.ac.uk/DARA/unit4/Workshops/EVN_continuum_part_1.html">(Ref)</a></h3>
<h4 id="general-information-of-the-data">3.1 General information of the data</h4>
<p>One of the most important aspects of data reduction is to <strong>understand your data!</strong>. Without knowing what your data looks like and its quality, the resultant calibration can often be sub-optimal. CASA provides lots of tools to assess and understand your data. The first, and one of the most essential of these is provided by the <code>listobs</code> task. This task outlines the <strong>structure</strong> of your data such as the frequencies observed, the antennas involved and the observing plan.</p>
<pre class="shell"><code>default(listobs)
vis=&#39;XXX.ms&#39;
listfile=&#39;XXX.ms.listobs&#39;   # This makes a file with the listobs info.
listobs()</code></pre>
<p>The command makes a file in the current working directory called <code>XXX.ms.listobs</code> which contains information about the measurement set. Try opening this file with your favourite text editor such as <code>gedit</code>. Remember a ! lets you run UNIX commands from CASA. So, if you use <code>cat</code>, the command to write in the command line would be <code>!cat XXX.ms.listobs</code>.</p>
<p>• Observer: XXX, Fields: 4, J0132+4325, XXX, 3C48, J0359+5057s</p>
<p>• Spectral Windows: 2, 1504 MHz, 1632 MHz, each 256 channels, chanel width 0.5 MHz, total BW 128 MHz. 4 polarisation products (RR RL LR LL)</p>
<p>• Antennas: 9. The offset from the array centre is 0 ß absolute Earth-centred (geocentric) coordinates are given for each antenna.</p>
<h4 id="correct-antenna-tables">3.2 Correct antenna tables</h4>
<h4 id="a-priori-calibration">3.3 A Priori Calibration</h4>
<p>The <code>append_tsys.py</code> <a href="https://github.com/jive-vlbi/casa-vlbi">(source github)</a> helper script was used to attach the system temperature information for each telescope to the FITS-IDI files. The system temperature is measured every few minutes. This compensates roughly for the different levels of signal from different sources, the effects of elevation and other amplitude fluctuations. Each antenna has a characteristic response in terms of Kelvin of system temperature per Jy of flux, so Tsys is also used to scale the flux density.</p>
<p>In CASA, calibration is conducted using calibration tables which are then used to modify the visibilities. To obtain our fluxscaling we therefore have to generate a system temperature calibration table using the task <code>gencal</code>. This task is used to generate caltables from ancillary information which can be found in the measurement set or in external files, and can also be used to create manual calibration tables from scratch. The <code>gencal</code> task has a special function to generate Tsys tables. To generate these tables we need to input:</p>
<pre class="shell"><code># In CASA
default(gencal)  # This reads the Tsys information appended to a ms
vis=&#39;XXX.ms&#39;
caltable=&#39;XXX.tsys&#39;
caltype=&#39;tsys&#39;
uniform=False   #Set to False to get spw dependent Tsys extraction
gencal()</code></pre>
<p>You will find that there is a new table named <code>XXX.tsys</code> which contains the gain information.</p>
<p><strong>Important:</strong> A key factor whenever generating calibration tables is to inspect them to see if there are errant values which simply do not make sense. To inspect tables, we can use either <code>plotcal</code> or, since CASA v5.4, <code>plotms</code>. For this example, we shall use <code>plotcal</code>. If we initialise the task (remember use <code>default</code>), we can see that we have to set the xx and yy axes along with what each plot shall be iterated over. So in this case we want to plot <strong>Tsys against frequency for each antenna</strong>. Note that the subplot parameter is the matplotlib subplot syntax. We should therefore input the following:</p>
<pre class="shell"><code>default(plotcal)
caltable=&#39;XXX.tsys&#39;
xaxis=&#39;freq&#39;
yaxis=&#39;tsys&#39;
subplot=321
iteration=&#39;antenna&#39;
plotcal()</code></pre>
<p>or if we use <code>plotms</code>:</p>
<pre class="shell"><code>default(plotms)
vis=&#39;XXX.tsys&#39;
xaxis=&#39;freq&#39;
yaxis=&#39;tsys&#39;
gridrows=3
grodcols=3
iteraxis=&#39;antenna&#39;
go</code></pre>
<p>We can also see how the Tsys changes over time! Most parameters are already set from the last run of <code>plotms</code>, therefore we can just write (and remembering to check the inputs before running!):</p>
<pre class="shell"><code>xaxis=&#39;time&#39;
go</code></pre>
<p>You can see the changes with each source change.</p>
<h5 id="obtain-gaincurve-file-.gc-antenna-gain-elevation-curve-calibration">Obtain gaincurve file .gc <a href="https://casa.nrao.edu/Release3.3.0/docs/UserMan/UserMansu175.html">(Antenna Gain-Elevation Curve Calibration)</a></h5>
<p>In the next step we will generate the gain curve table. This provides the scaled gain-elevation correction which scales the visibility amplitudes to the sensitivity of the dish, albeit without any allowance for weather or source contributions. Again, we use <code>gencal</code> to do this and the gain information (<code>XXX.gc</code>) that we <strong>extracted from the .antab file</strong>:</p>
<pre><code># In CASA
default(gencal)
vis=&quot;XXX.ms&quot;
caltable= &quot;XXX.gcal&quot; ## Name of output gain curve cal. table
caltype=&quot;gc&quot;           ## Special caltype for gaincurves
infile=&quot;XXX.gc&quot;      ## Gaincurve information derived from antab file
gencal()</code></pre>
<h4 id="inspect-and-flag-data-corresponding-to-section-d-in-evn_continuum_part_1">3.4 Inspect and flag data (corresponding to section D in <a href="http://www.jb.man.ac.uk/DARA/unit4/Workshops/EVN_continuum_part_1.html">EVN_continuum_part_1</a>)</h4>
<p><strong>One of the most important aspects of radio interferometric data reduction is identifying and removing bad data (This way AOFlagger is so cool)</strong>. Often these data is due to Radio Frequency Interference (RFI) from satellites and mobile phones <a href="https://zhuanlan.zhihu.com/p/114612502">3G，4G，5G的频率和频段是多少?</a> - 3G 约 2 GHz，4G 约 2.5 GHz，5G约 3.5 GHz 和 5 GHz</p>
<p>Sometimes it can be many other factors such as correlation errors or antennas off source. <strong>While it sounds tedious, the effects of bad data can be significant if ignored therefore careful extraction and removal of bad data is of paramount importance.</strong> In the next, we shall inspect our visibilities and attempt to flag and remove bad data.</p>
<ul>
<li><p>To begin, we shall remove the autocorrelations as these are not useful for continuum interferometric observations. To do this we use the manual flagging task called <code>flagdata</code>. Take a look at the inputs. To flag all of the autocorrelations we simply leave all as default (i.e. all data is selected) and set the <code>autocorr</code> parameter to be True</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>default(flagdata)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>vis <span class="op">=</span> <span class="st">&quot;XXX.ms&quot;</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>mode <span class="op">=</span> <span class="st">&quot;manual&quot;</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>autocorr <span class="op">=</span> <span class="va">True</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>go    </span></code></pre></div></li>
<li><p>Next we can see what telescopes are involved and their position relative to each other, using the CASA task <code>plotants</code></p>
<div class="sourceCode" id="cb9"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>default(plotants)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>vis <span class="op">=</span> <span class="st">&quot;XXX.ms&quot;</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>figfile <span class="op">=</span> <span class="st">&quot;antanas&quot;</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>go</span></code></pre></div>
<figure>
<img src="/Users/anything/THU/astro/notes/mdfiles/casa.assets/antanas.png" alt="antanas" /><figcaption aria-hidden="true">antanas</figcaption>
</figure></li>
<li><p>To inspect the quality of the data, we are going to use the task <code>plotms</code> to look for bad data. We start by looking at a bright source where it is easiest to tell good and bad data apart. The <code>plotms</code> task is very complicated (see its inputs) and takes time to understant. We look at the frequency axes first (so we can average the time axes) and look at the baselines to the most sensitive telescope (e.g. the 100m Effelsberg dish if its on the baseline network).</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>default(plotms)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>vis <span class="op">=</span> <span class="st">&quot;F.ms&quot;</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>xaxis <span class="op">=</span> <span class="st">&quot;frequency&quot;</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>yaxis <span class="op">=</span> <span class="st">&quot;amp&quot;</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>field<span class="op">=</span><span class="st">&#39;J0132+4325&#39;</span>        <span class="co"># The phase-cal/bandpass cal</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="co"># avgtime is depend on the actual duration</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>avgtime<span class="op">=</span><span class="st">&#39;3600&#39;</span>          <span class="co"># Will only average within scans unless additionally told to average scans too</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>antenna<span class="op">=</span><span class="st">&#39;MK&amp;*&#39;</span>          <span class="co"># Plot all baselines to the largest and most sensitive antenna</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="co"># maybe not MK, I use PT in the GUI</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>correlation<span class="op">=</span><span class="st">&#39;RR,LL&#39;</span>     <span class="co"># Only plot the parallel hands; the cross hands are fainter (and we won&#39;t be using them).</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>coloraxis<span class="op">=</span><span class="st">&#39;antenna2&#39;</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>go</span></code></pre></div>
<p>Then use icons on the GUI to check what antennas should be flagged (those who has 0 amplitude with the most sensitive antenna).</p>
<figure>
<img src="/Users/anything/THU/astro/notes/mdfiles/casa.assets/amp_freq-8441962.png" alt="amp_freq" /><figcaption aria-hidden="true">amp_freq</figcaption>
</figure></li>
</ul>
<p><strong>Important:</strong> Before more flagging, remember to back up the current flags. Do this any time you think you might need to change your mind about flagging. Use a different version name each time and make a note of it (CASA task <code>flagdata</code> can make an automatic backup but it will not have a memorable name). The backups for this data set are stored in <code>XXX.ms.flagversions</code>. We will now back up the flags for this data set now using the task <code>flagmanager</code>. The same task can be used to revert back to old flags too!:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>default(flagmanager)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>vis <span class="op">=</span> <span class="st">&quot;F.ms&quot;</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>mode<span class="op">=</span><span class="st">&#39;save&#39;</span>           <span class="co"># This mode saves the current flags, use the mode restore to revert to old flagging versions</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>versionname<span class="op">=</span><span class="st">&#39;test&#39;</span>  <span class="co"># This is the version name, you can see all version names in flagversions by using mode=&#39;list&#39;</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>go</span></code></pre></div>
<ul>
<li>If we find/identified that the XX telescope is not working properly, we can flag the telescopes using the <code>flagdata</code> task that we used earlier.</li>
</ul>
<div class="sourceCode" id="cb12"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>default(flagdata)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>vis<span class="op">=</span><span class="st">&#39;F.ms&#39;</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>mode<span class="op">=</span><span class="st">&#39;manual&#39;</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>antenna<span class="op">=</span><span class="st">&#39;XX&#39;</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>go()</span></code></pre></div>
<ul>
<li>Now we should re-inspect the data for any more corrupted data. Plot the most sensitive baseline to see the end channels more clearly and note which are below about half the maximum amplitude. These cause issues further down the line if not flagged and do not contribute much to the final image sensitivity.</li>
</ul>
<div class="sourceCode" id="cb13"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># In CASA</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>default(plotms)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>vis<span class="op">=</span><span class="st">&#39;n14c3.ms&#39;</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>xaxis<span class="op">=</span><span class="st">&#39;channel&#39;</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>yaxis<span class="op">=</span><span class="st">&#39;amp&#39;</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>field<span class="op">=</span><span class="st">&#39;1848+283&#39;</span>        <span class="co"># The phase-cal/bandpass cal</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>avgtime<span class="op">=</span><span class="st">&#39;3600&#39;</span>          <span class="co"># Will only average within scans unless additionally told to average scans too</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>antenna<span class="op">=</span><span class="st">&#39;EF&amp;JB&#39;</span>          <span class="co"># Plot the baseline of largest and most sensitive antennas</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>correlation<span class="op">=</span><span class="st">&#39;RR,LL&#39;</span>     <span class="co"># Only plot the parallel hands; the cross hands are fainter (and we won&#39;t be using them).</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>iteraxis<span class="op">=</span><span class="st">&#39;spw&#39;</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>plotms()</span></code></pre></div>
<ul>
<li>Use the arrows at the bottom of <code>plotms</code> to scroll through the spw (which should got through the subplots above). Odd and even spw behave differently but there is no need to spend too much time on this as the suggested channels to flag are given here for time saving purposes:</li>
</ul>
<div class="sourceCode" id="cb14"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># In CASA</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>default(flagdata)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>vis<span class="op">=</span><span class="st">&#39;n14c3.ms&#39;</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>mode<span class="op">=</span><span class="st">&#39;manual&#39;</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>spw<span class="op">=</span><span class="st">&#39;0:0~5;29~31,2:0~5;29~31,4:0~5;29~31,6:0~5;29~31,1:0~2;27~31,3:0~2;27~31,5:0~2;27~31,7:0~2;27~31&#39;</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>flagdata()</span></code></pre></div>
<ul>
<li>Next we shall look at amp vs. time instead, now averaging in frequency:</li>
</ul>
<div class="sourceCode" id="cb15"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># In CASA</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>default(plotms)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>vis<span class="op">=</span><span class="st">&#39;F.ms&#39;</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>xaxis<span class="op">=</span><span class="st">&#39;time&#39;</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>yaxis<span class="op">=</span><span class="st">&#39;amp&#39;</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>field<span class="op">=</span><span class="st">&#39;B0128+437&#39;</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>spw<span class="op">=</span><span class="st">&#39;0~1&#39;</span>        <span class="co"># Average a few central channels where the response is stable</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>avgchannel<span class="op">=</span><span class="st">&#39;8&#39;</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>antenna<span class="op">=</span><span class="st">&#39;PT&amp;MK&#39;</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>correlation<span class="op">=</span><span class="st">&#39;RR,LL&#39;</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>coloraxis<span class="op">=</span><span class="st">&#39;baseline&#39;</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>plotms()</span></code></pre></div>
<ul>
<li>Note that the first one or two integrations of some scans are bad. There is a specific <code>flagdata</code> mode for this called quack. We will safely assume that all sources are affected.</li>
</ul>
<div class="sourceCode" id="cb16"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>default(flagdata)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>vis<span class="op">=</span><span class="st">&#39;n14c3.ms&#39;</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>mode<span class="op">=</span><span class="st">&#39;quack&#39;</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>quackinterval <span class="op">=</span> <span class="dv">5</span>     <span class="co"># 5 seconds, or just over 2 intgrations</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>go</span></code></pre></div>
<ul>
<li>Now go through each baseline to identify remaining bad data (enter <code>iteration='baseline'</code> and re-load <code>plotms</code>). Again, this has already been listed so don’t spend too long, just make sure you have some idea of how to identify and record bad data. There is more than one bad scan on HH and as we are plotting the phase-cal it is likely that the target in-between was affected. Plot this.</li>
</ul>
<div class="sourceCode" id="cb17"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>default(plotms)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>vis<span class="op">=</span><span class="st">&#39;n14c3.ms&#39;</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>xaxis<span class="op">=</span><span class="st">&#39;time&#39;</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>yaxis<span class="op">=</span><span class="st">&#39;amp&#39;</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>scan<span class="op">=</span><span class="st">&#39;60~70&#39;</span>            <span class="co"># a few scans including the bad data; plot all fields in this time range</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>spw<span class="op">=</span><span class="st">&#39;0~7:13~20&#39;</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>avgchannel<span class="op">=</span><span class="st">&#39;8&#39;</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>antenna<span class="op">=</span><span class="st">&#39;EF&amp;HH&#39;</span>         <span class="co"># just the relevant baseline</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>correlation<span class="op">=</span><span class="st">&#39;RR,LL&#39;</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>coloraxis<span class="op">=</span><span class="st">&#39;field&#39;</span>       <span class="co"># distinguish sources</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>go</span></code></pre></div>
<ul>
<li>Flag the scans when the target (in brown in the plot here) goes right to zero. Or for time-saving purposes we have put the commands in here for you.</li>
</ul>
<div class="sourceCode" id="cb18"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>default(flagdata)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>vis<span class="op">=</span><span class="st">&#39;n14c3.ms&#39;</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>antenna<span class="op">=</span><span class="st">&#39;HH&#39;</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>mode<span class="op">=</span><span class="st">&#39;manual&#39;</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>scan<span class="op">=</span><span class="st">&#39;62~65&#39;</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>go</span></code></pre></div>
<ul>
<li>Next, lets inspect the next most distant antenna, SH</li>
</ul>
<div class="sourceCode" id="cb19"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>default(plotms)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>vis<span class="op">=</span><span class="st">&#39;n14c3.ms&#39;</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>xaxis<span class="op">=</span><span class="st">&#39;time&#39;</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>yaxis<span class="op">=</span><span class="st">&#39;amp&#39;</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>field<span class="op">=</span><span class="st">&#39;1848+283&#39;</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>spw<span class="op">=</span><span class="st">&#39;0~7:13~20&#39;</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>avgchannel<span class="op">=</span><span class="st">&#39;8&#39;</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>antenna<span class="op">=</span><span class="st">&#39;EF&amp;SH&#39;</span>         <span class="co"># just the relevant baseline</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>correlation<span class="op">=</span><span class="st">&#39;RR,LL&#39;</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>coloraxis<span class="op">=</span><span class="st">&#39;spw&#39;</span>         <span class="co"># distinguish spw</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>go</span></code></pre></div>
<ul>
<li>There are many short, bad periods, some only affecting certain spw. The easiest way to cope with this is to write a flag list. Identify antennas/spw/times, adding 1s to the start and finish of each flagging period. They are all shorter than one scan so the same flags aren’t applied to the target but later, we will look for similar bad data on the target. Take a look at the flag list file: <code>flagSH.flagcmd</code> which is in your current directory and cross-check that these entered values are affected.</li>
</ul>
<p>If you are happy, then we will use this file to automatically flag those channels specified in the file:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>default(flagdata)</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>vis<span class="op">=</span><span class="st">&#39;n14c3.ms&#39;</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>mode<span class="op">=</span><span class="st">&#39;list&#39;</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>inpfile<span class="op">=</span><span class="st">&#39;flagSH.flagcmd&#39;</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>go</span></code></pre></div>
<p>Let’s reinspect to check that the bad data are all gone:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>default(plotms)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>vis<span class="op">=</span><span class="st">&#39;n14c3.ms&#39;</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>xaxis<span class="op">=</span><span class="st">&#39;time&#39;</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>yaxis<span class="op">=</span><span class="st">&#39;amp&#39;</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>field<span class="op">=</span><span class="st">&#39;1848+283&#39;</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>spw<span class="op">=</span><span class="st">&#39;0~7:13~20&#39;</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>avgchannel<span class="op">=</span><span class="st">&#39;8&#39;</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>antenna<span class="op">=</span><span class="st">&#39;EF&amp;*&#39;</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>coloraxis<span class="op">=</span><span class="st">&#39;corr&#39;</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>correlation<span class="op">=</span><span class="st">&#39;RR,LL&#39;</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>go</span></code></pre></div>
<figure>
<img src="http://www.jb.man.ac.uk/DARA/unit4/Workshops/EVN_continuum_plots/part1/n143c_amp_vs_time_uncal_flagged.png" alt="img" /><figcaption aria-hidden="true">img</figcaption>
</figure>
<p>Hooray, the data looks clean! We can finally begin to calibrate these data!</p>
<h4 id="fringe-fitting">3.5 Fringe fitting</h4>
<p>Now that all the data has been cleaned up, we can begin to think about calibrating these data.</p>
<p>As you may remember from the accompanying lectures, the wavefronts arriving at two different telescopes from a single source arrives at different times, i.e. one signal is delayed relative to each other. This is shown by the <span class="math inline"><em>D</em>sin (<em>θ</em>)</span> term in the two-element interferometer shown below:</p>
<figure>
<img src="http://www.jb.man.ac.uk/DARA/unit4/Workshops/EVN_continuum_plots/part1/two_element_inter.png" alt="img" /><figcaption aria-hidden="true">img</figcaption>
</figure>
<h4 id="bandpass-calibration">3.6 Bandpass calibration</h4>
<h4 id="split-out-phase-ref-target-pairs">3.7 Split out phase-ref-target pairs</h4>
<h3 id="install-casacore-aoflagger-and-wsclean-on-debian">Install casacore, aoflagger and wsclean on Debian</h3>
<pre class="shell"><code>sudo apt update
sudo apt search casacore
sudo apt install casacore-tools casacore-dev libcasa-casa3 python3-casacore casacore-data casacore-data-sources
sudo apt install aoflagger #(should be version 2.14.0, 2019.02.14)

# to reinstall, first sudo apt remove XXX
# and sudo apt autoremove
# then run sudo apt install XXX again

sudo apt install wsclean #(should be version 2.8.0, 2019.09.16)

apt list -a &lt;package name&gt;
apt-cache madison aoflagger

If you can not install the latest version, you can find a specific one on https://packages.debian.org/stable/allpackages
or
https://packages.debian.org/testing/allpackages

or, if you can install a version you want in ubuntu, you can:
Google: ubuntu create deb from installed package

**Or, you should directly download package source file in the website: https://sourceforge.net/p/aoflagger/wiki/Home/**

</code></pre>
<p>Because of MacOS Catalina has some issues when install casacore, so aoflagger cannot be installed on MacOS. <strong>To use gui tools on linux server, we can add -X option when login into the remote server:</strong></p>
<pre class="shell"><code>ssh -p2222 -X username@XXX</code></pre>
<p>After logining in, a small logo will show on Docker: <img src="/Users/anything/THU/astro/notes/mdfiles/casa.assets/image-20201216163836420.png" alt="image-20201216163836420" /></p>
<p>and after you run the <strong>rfigui</strong>, the window will be opened on Mac:</p>
<figure>
<img src="/Users/anything/THU/astro/notes/mdfiles/casa.assets/image-20201216164043491.png" alt="image-20201216164043491" /><figcaption aria-hidden="true">image-20201216164043491</figcaption>
</figure>
<h5 id="install-casa-on-debian-ref-and-also-here">Install casa on Debian <a href="https://casa.nrao.edu/casadocs/latest/usingcasa/obtaining-and-installing">(ref)</a> and also <a href="https://casaguides.nrao.edu/index.php/Installing_CASA">here</a></h5>
<pre class="shell"><code># python3 --version Python 3.7.3 --&gt; must use Python 3.6
python3 -m venv casa6
source casa6/bin/activate
pip install --index-url https://casa-pip.nrao.edu/repository/pypi-casa-release/simple casatools
pip install --index-url https://casa-pip.nrao.edu/repository/pypi-casa-release/simple casatasks
# Above does not works unless python3.6 is installed, I choose not use this way to install, since not only the python version matters, pip tool also needs to mathch, not convenient.

# I choose download the tar.xz file directly and then unpack the software.</code></pre>
<p>Also, The Ubuntu installation instructions work well for Debian as well. However, if “xvfb” is not installed on your machine, CASA may start with errors like this:</p>
<p>casalogger: cannot connect to X server localhost:10.0</p>
<p>If so, try this:</p>
<pre><code>sudo apt-get install xvfb</code></pre>
<p>Then restart CASA and the problem should be solved.</p>
<p><strong>Besides, do not close the popped window by click by hand, use the quit Manu of the software (or Ctrl+C on linux shell directly), otherwise the XQuartz will not working anymore, you need to relogin.</strong></p>
</body>
</html>
